<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Lameboy - iko&#39;s logs
    
  </title>

  <meta name="description" content="An attempt at writing a gameboy emulator and running it on FPGA">
  <meta property="og:description" content="An attempt at writing a gameboy emulator and running it on FPGA">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Lameboy">
  <meta property="og:url" content="https://ikouchiha47.github.io/2024/04/20/gameboy-emulator.html">

  
    <meta property="og:image" content="https://ikouchiha47.github.io/img/gameboycollage.jpg"/>
  

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <!-- <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script> -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous"/>

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://ikouchiha47.github.io/2024/04/20/gameboy-emulator.html">
  <link rel="alternate" type="application/rss+xml" title="iko&#39;s logs" href="/feed.xml">

  <meta name="google-site-verification" content="lWkg6gIxJgzEKX_5XnhcxCtPE9QknaimFWWos_dTvPM" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Inconsolata:wght@200..900&family=Jersey+25&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Merriweather+Sans:ital,wght@0,300..800;1,300..800&family=Nanum+Gothic+Coding&family=Space+Grotesk:wght@300..700&family=Titillium+Web:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700&display=swap" rel="stylesheet">

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">iko&#39;s logs</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">Posts</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/contact">Contact</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background-image: url('/img/gameboycollage.jpg')">

  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <div class="post-heading">
          <h1>Lameboy</h1>
          
          <h2 class="subheading">Yet yet another gameboy emulator</h2>
          
          <span class="meta">Posted by
            <a href="#">ikouchiha47</a>
            on April 20, 2024 &middot; <span class="reading-time" title="Estimated read time">
  
   9 mins  read </span>

          </span>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="container space-grotesk">
  <div class="row">
    <div class="col-lg-8 col-md-10 mx-auto">

      <h1 id="emulating-the-gamebouy">Emulating the Gamebouy</h1>

<p>I have never played with one, and maybe I don’t want to either. While that
doesn’t mean I don’t like the engineering behind it.</p>

<p>After spending a good length of time with your keyboard, its probably
pre-destined for most developers to end up writing an emulator. I maybe a bit
late to the party. But I come in with the newest sick language in town. <a href="https://ziglang.org/documentation/master/">Zig</a></p>

<p>At the time of writing this, zig was yet to release their 0.12.0 version. This
version included the package manager. And I was using their master branch. It
just feel real <em>hip</em> to wait for a feature land into production in near real-time in opensource world.</p>

<p>Anywho.</p>

<p>I was inspired by the history of how came into being. From two youtube videos:</p>

<ul>
  <li><a href="https://www.youtube.com/watch?v=9Ki-kH751_8">How the Game Boy ᵃˡᵐᵒˢᵗ ruined Nintendo</a></li>
  <li><a href="https://www.youtube.com/watch?v=HyzD8pNlpwI">The Ultimate Gameboy Talk</a></li>
</ul>

<p>At this time, I was also, reading how memory and cpu works. And writing an
emulator felt like the right idea to understand this better.</p>

<p>The choice of zig is mostly because it was a better C. Without the package
manager thought, I would have gone back to <code class="language-plaintext highlighter-rouge">golang</code></p>

<p><br /></p>

<h2 id="chip-8">Chip 8</h2>

<p>Its a customary step in the world emulator dev, to start with a CHIP-8 emulator,
before attempting a <code class="language-plaintext highlighter-rouge">NES</code>, or <code class="language-plaintext highlighter-rouge">GB</code> and then a <code class="language-plaintext highlighter-rouge">GBA</code>.</p>

<p>CHIP-8 is not like gameboy, it’s more of a programming language, which came with its own VM, much like
java. This allowed people to write video games easier.</p>

<p>Gameboy on the other hand used a Silicon on Chip (LR35902) as its processor, RAM capable of 
fetching, decoding and executing instructions.</p>

<p>One of the <strong>main differences</strong> is the clock cycle. CHIP-8 running on a VM, was
too simple. Most instructions now, are assumed to take the same clock cycle. The
clock those days wee too less, so, those era of machines took some time to
execute the equivalent CPU instruction, but overall 60Hz.</p>

<p>That’s approximately 16 ticks. (1/60) * 1000.</p>

<p>While the gameboy’s processor took different number of clock cycles, for
different instructions.</p>

<ul>
  <li>Although some CHIP-8 emulations tries to follow the <a href="https://jackson-s.me/2019/07/13/Chip-8-Instruction-Scheduling-and-Frequency.html">Scheduling frequency</a>. But they do an equivalent of <code class="language-plaintext highlighter-rouge">time.sleep(ms)</code>, but it’s not the correct way, because you are effectively robbing the cpu in the vm from execute any work inbetween. *</li>
</ul>

<p>The best way to do this is to use a</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enum CpuState {
    Running
    IoWaiting
}
</code></pre></div></div>
<p>and, then use the <code class="language-plaintext highlighter-rouge">ticks</code> logic provided by the <strong>UI library</strong>. So for
<code class="language-plaintext highlighter-rouge">javascript</code> it would be <code class="language-plaintext highlighter-rouge">requestAnimationFrame</code>, for <strong>cliers</strong>, it would be
the ticks provided by the <code class="language-plaintext highlighter-rouge">SDL2</code> library. (or whatever your prefered is, just
don’t sleep.). Every tick, the exectuor always renders, and runs the cpu cycle
as long as the <code class="language-plaintext highlighter-rouge">CpuState</code> is <code class="language-plaintext highlighter-rouge">Running</code>.</p>

<p>So, the CPU execution stops only when you are waiting for an user input, in
which case <code class="language-plaintext highlighter-rouge">CpuState</code> is <code class="language-plaintext highlighter-rouge">IoWaiting</code>.</p>

<p>The <a href="https://en.wikipedia.org/wiki/CHIP-8">Wikipedia</a> link does a better job of explaning what it is. CHIP-8 emulators need to 
implement only 34 instructions, <em>and you can skip the sound implementation ;)</em></p>

<p>Here is the docs from <a href="/posts/chip8.html">https://web.archive.org/web/*/https://devernay.free.fr/hacks/chip8/C8TECH10.HTM</a>, in a better format. Following the rules from <a href="http://bettermotherfuckingwebsite.com/">http://bettermotherfuckingwebsite.com/</a></p>

<p>And people have written in details on how it works, and how to implement one:</p>

<ul>
  <li><a href="https://austinmorlan.com/posts/chip8_emulator/">https://austinmorlan.com/posts/chip8_emulator/</a></li>
  <li><a href="https://tobiasvl.github.io/blog/write-a-chip-8-emulator/">https://tobiasvl.github.io/blog/write-a-chip-8-emulator/</a></li>
</ul>

<p>are the two popular ones. Wikipedia article is your best guide. In case you face
issues, the <a href="https://www.reddit.com/r/EmuDev/">r/EmuDev</a> , reddit community is
pretty helpful and so is their discord channel.</p>

<p>In the end it should look like:</p>

<p><img src="/img/invaders_screen_1.png" alt="invaders loading screen" width="400" /></p>

<p><img src="/img/invaders_screen_2.png" alt="game screen" width="400" /></p>

<h4 id="some-learnings-from-chip-8">Some learnings from CHIP-8</h4>

<ul>
  <li>
    <p>A memory, is formed using a gated latch or transistors. The first one is SRAM
and the second is a DRAM. Both have their advantages and disadvantages.</p>
  </li>
  <li>
    <p>This latches have a data line and a write enabled line. So, a latch can store
1 bit of memory (1 or 0). For 8 bits, we need 8 registers, addressing memory
(2^8=)256bits</p>
  </li>
  <li>
    <p>As memory grew, these cells were arranged in matrices. The addressing is
therefore must consists of which row and column the memory cell is in.
Further memory is also arranged in banks and multiple banks are grouped
together. This all leads you to <code class="language-plaintext highlighter-rouge">page</code>, <code class="language-plaintext highlighter-rouge">page frames</code>, <code class="language-plaintext highlighter-rouge">TLB</code>, <code class="language-plaintext highlighter-rouge">MMU</code>, and <code class="language-plaintext highlighter-rouge">OS
Pages</code></p>
  </li>
  <li>
    <p>A modern day DRAM consumes much less voltage to indicate a bit (1/0), than
SRAM. While SRAMs don’t suffer from data leakage, DRAMs have cacpitors as
memory cells. So each read causes some voltage to leak while reading, and
hence the data needs to be written back. Also a different module to make sure
the data is not lost overtime.</p>
  </li>
  <li>
    <p>Given the above, DRAMs henceforth, needs electricity to keep running. And is
much much much faster than SRAM.</p>
  </li>
  <li>
    <p>CPU moves the data between the DRAM and the SSD. Here we can read in details
about memory banks and how these days DRAMs, uses 32bit data lines and
control wires works, further by splitting memory in 8bits of 4 groups. This
memory banking will come in handy when building the gameboy emulator. For
<strong>CHIP-8</strong> everything fits in memory.</p>
  </li>
  <li>
    <p>Although a chip-8 uses 8bit registers, instructions requires 16bits, and
this is done, by accessing 2 words, using the <strong>Program Counter</strong>. And then
using a 16bit register, to store the two 8bit values. <code class="language-plaintext highlighter-rouge">(lo &lt;&lt; 8) as u16 | hi</code></p>
  </li>
  <li>
    <p>Processing each opcode, it doesn’t take much of a learning curve once you have
figured out bit manipulation. One of the things to keep it mind, is to clamp
the values for each registers, and program counter, so that memory access doesn’t 
go out of available space.</p>
  </li>
  <li>
    <p><strong>Timing</strong> is a bitch.</p>
  </li>
  <li>
    <p><strong>Overall</strong>, its quite fun to watch how fast the cpu <code class="language-plaintext highlighter-rouge">Fetch</code>, <code class="language-plaintext highlighter-rouge">Decode</code> and
<code class="language-plaintext highlighter-rouge">Execute</code> cycle works.</p>
  </li>
  <li>
    <p>The last thing was interupt handling. The way interrupts are handled is, when
you press a key, the CPU state changes, and it takes the key pressed, is puts
in a register. After which, the CPU state is changed to <code class="language-plaintext highlighter-rouge">Running</code>.
The program (in this case the CHPI-8 game), is responsible for using an
Instruction to read this registered key pressed from the <code class="language-plaintext highlighter-rouge">register</code>.
This is called <strong>Memory Mapped IO</strong></p>
  </li>
</ul>

<p><strong>Implementation Gotchas</strong></p>

<ul>
  <li>For each stage, use the chip8 programs that are used to test the emulator,
<a href="https://github.com/Timendus/chip8-test-suite">here</a></li>
  <li>The initial commit, should contain, initializing the empty memory, adding the
sprites and then loading the game data into memory from the address 0x0200</li>
  <li>With each step, test the emulator with the <strong>roms</strong> in the <code class="language-plaintext highlighter-rouge">test suite</code>.</li>
  <li>Try to display the IBM Logo as the first step. (I know, IBM. What days).</li>
  <li>Get familiar with writing shit in hex. Like <code class="language-plaintext highlighter-rouge">0x1000</code> , for 4kb. (0-4095).</li>
</ul>

<p><br /></p>

<h2 id="gamebouy">Gamebouy</h2>

<p><em>Turn down for what.</em></p>

<p>There are a couple of things to be excited about, while making the emulator for
gameboy.</p>

<p><em>I am skipping the sound for this one too, I only like trumpet music</em></p>

<ul>
  <li>
    <p>The games sometimes, are much larger than then available memory a gameboy had
to deal with. Which was somewhere around 64K address space. So, shit like
<code class="language-plaintext highlighter-rouge">0xffff</code></p>
  </li>
  <li>
    <p>You have only 32KB of ROM, where game is read from. And the rest 32KB is
distributed amongs VRAM, ERAM, HRAM etc. The ROM is more of a switchable ROM.</p>
  </li>
  <li>
    <p>For games that don’t fit in the address range (0x4000-0x7FFF) , they need to
be loaded from disk, the memory in cartdige i guess.</p>
  </li>
  <li>
    <p>16bits are used for addressing. Including peripherials.</p>
  </li>
</ul>

<p><strong>Sources</strong>:</p>

<ul>
  <li><a href="https://gbdev.gg8.se/wiki/articles/CPU_Registers_and_Flags">https://gbdev.gg8.se/wiki/articles/CPU_Registers_and_Flags</a></li>
  <li><a href="https://mgba-emu.github.io/gbdoc/">https://mgba-emu.github.io/gbdoc/</a></li>
  <li><a href="https://rylev.github.io/DMG-01/public/book/cpu/registers.html">https://rylev.github.io/DMG-01/public/book/cpu/registers.html</a></li>
  <li><a href="https://blog.rekawek.eu/2017/02/09/coffee-gb/">https://blog.rekawek.eu/2017/02/09/coffee-gb/</a></li>
</ul>

<p>To be continued…</p>


      <hr>
      <div class="row mb-5 mt-5">
  <div class="col-md-6 d-flex align-items-end ">
    <span>Thanks. <i>mind sharing?</i></span>
  </div>

  <!-- Right Column with Social Media Icons (on the right for larger screens, on bottom for smaller screens) -->
  <div class="col-md-6 order-md-2 order-1 text-md-right text-center mt-3 mt-md-0">
    <div>

      <a
          href="https://www.linkedin.com/sharing/share-offsite?url=ikouchiha47.github.io/2024/04/20/gameboy-emulator.html"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          class="d-inline-block mr-2"
       >
        <span class="fa-stack fa-lg" style="color: #0077b5;">
          <i class="fas fa-square fa-stack-2x"></i>
          <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
        </span>
      </a>

      <a
          href="https://twitter.com/intent/tweet?text=Lameboy&url=ikouchiha47.github.io/2024/04/20/gameboy-emulator.html"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          class="d-inline-block mr-2">
        <span class="fa-stack fa-lg" style="color: #1DA1F2;">
          <i class="fas fa-square fa-stack-2x"></i>
          <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
      </a>

      <a
          href="http://www.reddit.com/submit?url=ikouchiha47.github.io/2024/04/20/gameboy-emulator.html"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          class="d-inline-block mr-2">
        <span class="fa-stack fa-lg" style="color: #FF4500;">
          <i class="fas fa-square fa-stack-2x"></i>
          <i class="fab fa-reddit fa-stack-1x fa-inverse"></i>
        </span>
      </a>
    </div>
  </div>
</div>

<hr/>


      <div class="clearfix">

        
        <a class="btn btn-primary float-left" href="/2024/02/05/elaru-cache.html" data-toggle="tooltip" data-placement="top" title="YALC">&larr; Previous<span class="d-none d-md-inline">
            Post</span></a>
        
        
        <a class="btn btn-primary float-right" href="/2024/04/20/file-storage-system-design.html" data-toggle="tooltip" data-placement="top" title="Arbok">Next<span class="d-none d-md-inline">
            Post</span> &rarr;</a>
        

      </div>

    </div>
  </div>
</div>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:amitava.dev@proton.me" class="text-gray">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          <li class="list-inline-item">
            <a href="https://www.linkedin.com/in/amitavaag" class="text-gray">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://github.com/ikouchiha47" class="text-gray">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
        </ul>

        <p class="copyright text-muted">
          Build with: 
          <a 
            href="https://github.com/StartBootstrap/startbootstrap-clean-blog-jekyll"
            class="text-gray"
            target="_blank">startbootstrap-clean-blog-jekyll</a></p>
      </div>
    </div>
  </div>
</footer>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/blog/js/scripts.js"></script>

<script src="/assets/scripts.js"></script>




  

</body>

</html>
