<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Automate deployment with CI/CD - iko&#39;s logs
    
  </title>

  <meta name="description" content="Setting up ci/cd on gitlab and automate deployment with terraform">
  <meta property="og:description" content="Setting up ci/cd on gitlab and automate deployment with terraform">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Automate deployment with CI/CD">
  <meta property="og:url" content="https://ikouchiha47.github.io/2024/01/11/ci-cd-with-gitlab-aws.html">

  

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <!-- <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script> -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous"/>

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://ikouchiha47.github.io/2024/01/11/ci-cd-with-gitlab-aws.html">
  <link rel="alternate" type="application/rss+xml" title="iko&#39;s logs" href="/feed.xml">

  <meta name="google-site-verification" content="lWkg6gIxJgzEKX_5XnhcxCtPE9QknaimFWWos_dTvPM" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Inconsolata:wght@200..900&family=Jersey+25&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Merriweather+Sans:ital,wght@0,300..800;1,300..800&family=Nanum+Gothic+Coding&family=Space+Grotesk:wght@300..700&family=Titillium+Web:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700&display=swap" rel="stylesheet">

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">iko&#39;s logs</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">Posts</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/contact">Contact</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background: #da46ff">

  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <div class="post-heading">
          <h1>Automate deployment with CI/CD</h1>
          
          <h2 class="subheading">Simple setup using gitlab, aws and terraform</h2>
          
          <span class="meta">Posted by
            <a href="#">ikouchiha47</a>
            on January 11, 2024 &middot; <span class="reading-time" title="Estimated read time">
  
   16 mins  read </span>

          </span>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="container space-grotesk">
  <div class="row">
    <div class="col-lg-8 col-md-10 mx-auto">

      <h1 id="streamlining-infrastructure-management-with-iac">Streamlining Infrastructure Management with IaC</h1>

<p>In the world of cloud computing, managing infrastructure can be a complex and time-consuming task. Manual configuration and provisioning can lead to inconsistencies, errors, and delays. Infrastructure as Code (IaC) provides a solution by allowing you to define your infrastructure using code, enabling version control, automated deployments, and consistent environments.</p>

<p>Our IaC Journey with Terraform</p>

<p>We recently embarked on an IaC journey to streamline our deployment processes for multiple services within the Newsaggregator ecosystem. Here’s a breakdown of our approach:</p>

<h2 id="repositories-for-code-and-infrastructure">Repositories for Code and Infrastructure:</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">app-server</code>: Houses the server code.</li>
  <li><code class="language-plaintext highlighter-rouge">app-base-infra</code>: Contains code for setting up IAM, networking, and other foundational infrastructure.</li>
  <li><code class="language-plaintext highlighter-rouge">app-metals-infra</code>: Manages services using ASGs, EC2 instances, S3, Lambda, and more.</li>
</ul>

<h2 id="terraform-for-infrastructure-definition">Terraform for Infrastructure Definition:</h2>

<p>We chose <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template#network-interfaces">Terraform</a> as our IaC tool for its ease of use, comprehensive AWS support, and strong community. Terraform scripts define our infrastructure components, including:</p>

<ul>
  <li>IAM policies, roles, and users</li>
  <li>VPCs, subnets, and security groups</li>
  <li>Route53 records</li>
  <li>ACM certificates</li>
  <li>ECS tasks with autoscaling groups and load balancers</li>
  <li>S3 buckets</li>
  <li>Lambda functions</li>
</ul>

<h2 id="gitlab-ci-for-automated-pipelines">GitLab CI for Automated Pipelines:</h2>

<p>GitLab CI orchestrates our pipeline processes:</p>

<ul>
  <li>app-server CI pipeline:
    <ul>
      <li>Builds Docker images</li>
      <li>Tags images with commit hashes</li>
      <li>Uploads images to ECR</li>
      <li>Updates version numbers in SSM parameters</li>
    </ul>
  </li>
  <li>app-base-infra CD pipeline:
    <ul>
      <li>Sets up IAM, networking, and other foundational infrastructure</li>
    </ul>
  </li>
  <li>app-metals-infra CD pipeline:
`-Deploys ECS tasks, ASGs, load balancers and connects to cluster</li>
</ul>

<p>Secure AWS Credentials:</p>

<ul>
  <li>AWS access keys and secrets are stored as pipeline variables, ensuring security.</li>
</ul>

<p>For gitlab, you can chose the <em>Protected</em> and <em>Mask</em> checkboxes, to make those variables available
only in <em>protected</em> branches. (Check Branch protection rules in your gitlab ci setting)</p>

<h2 id="benefits-of-our-iac-implementation">Benefits of Our IaC Implementation:</h2>

<ul>
  <li>Automation: Eliminates manual configuration and provisioning.</li>
  <li>Consistency: Ensures identical environments across deployments.</li>
  <li>Version control: Tracks changes and enables rollbacks.</li>
  <li>Auditability: Provides clear history of infrastructure changes.</li>
  <li>Scalability: Facilitates easy infrastructure expansion.</li>
</ul>

<p>Next Steps:</p>

<ul>
  <li>Pipeline YAML sharing: We’ll share our pipeline YAML configurations for transparency and collaboration.</li>
  <li>ChatGPT integration: We’ll continue exploring ChatGPT’s potential for further automating policy creation and other tasks.</li>
</ul>

<h3 id="app-server-iaac-setup"><code class="language-plaintext highlighter-rouge">app-server</code> IaaC setup</h3>

<p>For our <code class="language-plaintext highlighter-rouge">app-server/.gitlab-ci.yaml</code>,these are the steps we take:</p>
<ul>
  <li>create iam role with access to <code class="language-plaintext highlighter-rouge">push pull images from ecr</code> and <code class="language-plaintext highlighter-rouge">ssm:GetParameters</code>, <code class="language-plaintext highlighter-rouge">ssm:PutParameter</code></li>
  <li>create the image from our <code class="language-plaintext highlighter-rouge">Dockerfile</code></li>
  <li>The docker <code class="language-plaintext highlighter-rouge">tag</code> is of the format <code class="language-plaintext highlighter-rouge">${APP_NAME}:${CI_COMMIT_SHORT_SHA}</code>.</li>
  <li>push it into the <code class="language-plaintext highlighter-rouge">ECR</code>.</li>
  <li>update the <code class="language-plaintext highlighter-rouge">SSM Param</code> with the <code class="language-plaintext highlighter-rouge">docker tag</code></li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">SSM Param</code> is of the format <code class="language-plaintext highlighter-rouge">/${ENVIRONMENT}/${APP_NAME}/apiserver/version</code></p>

<p>CI variables to set:</p>
<ul>
  <li>AWS_DEFAULT_REGION</li>
  <li>AWS_ACCOUNT</li>
  <li>AWS_ACCESS_KEY_ID</li>
  <li>AWS_SECRET_ACCESS_KEY</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">.gitlab-ci.yaml</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">variables</span><span class="pi">:</span>
  <span class="na">DOCKER_REGISTRY</span><span class="pi">:</span> <span class="s">${AWS_ACCOUNT}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"</span>
  <span class="na">DOCKER_APP_TAG</span><span class="pi">:</span> <span class="s">${APP_NAME}:${CI_COMMIT_SHA:0:6}</span> 
  <span class="na">DOCKER_HOST</span><span class="pi">:</span> <span class="s">tcp://docker:2375</span>
  <span class="na">APP_NAME</span><span class="pi">:</span> <span class="s">talon-server</span>

<span class="na">publish prod</span><span class="pi">:</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">ENVIRONMENT</span><span class="pi">:</span> <span class="s">prod</span>
  <span class="na">rules</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">if</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$CI_COMMIT_REF_NAME</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"master"'</span>
  <span class="na">image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">amazon/aws-cli:2.15.15</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">services</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker:dind</span>
  <span class="na">before_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">amazon-linux-extras install docker</span>
    <span class="pi">-</span> <span class="s">aws --version</span>
    <span class="pi">-</span> <span class="s">docker --version</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">echo ${AWS_PROFILE}</span>
    <span class="pi">-</span> <span class="s">echo ${AWS_DEFAULT_REGION}</span>
    <span class="pi">-</span> <span class="s">echo $CI_COMMIT_SHORT_SHA</span>
    <span class="pi">-</span> <span class="s">aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID</span>
    <span class="pi">-</span> <span class="s">aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY</span>
    <span class="pi">-</span> <span class="s">aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin "${AWS_ACCOUNT}.dkr.${AWS_DEFAULT_REGION}.amazonaws.com"</span>
    <span class="pi">-</span> <span class="s">docker build --platform linux/amd64  -t "talon-server:$CI_COMMIT_SHORT_SHA" .</span>
    <span class="pi">-</span> <span class="s">docker tag "${APP_NAME}:$CI_COMMIT_SHORT_SHA" "${AWS_ACCOUNT}.dkr.ecr.ap-south-1.amazonaws.com/talon-server:$CI_COMMIT_SHORT_SHA"</span>
    <span class="pi">-</span> <span class="s">docker push "${AWS_ACCOUNT}.dkr.ecr.ap-south-1.amazonaws.com/${APP_NAME}:$CI_COMMIT_SHORT_SHA"</span>
    <span class="pi">-</span> <span class="s">aws ssm put-parameter --name "/${ENVIRONMENT}/${APP_NAME}/apiserver/version" --value "${APP_NAME}:${CI_COMMIT_SHORT_SHA}" --type String --overwrite</span>

</code></pre></div></div>

<p>The Policy for Gitlab looks like:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"ecr:GetAuthorizationToken"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ecr:GetDownloadUrlForLayer"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ecr:DescribeRepositories"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ecr:ListImages"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ecr:DescribeImages"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ecr:ListTagsForResource"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ecr:DescribeImageScanFindings"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ecr:PutImage"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ssm:GetParameters"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ssm:PutParameter"</span><span class="p">,</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>This <code class="language-plaintext highlighter-rouge">SSM Param</code> allows the <code class="language-plaintext highlighter-rouge">CD</code> pipeline to determine which image to deploy. We are going to see later.</p>

<p>For the Networking setup and creating IAM roles for ECS to run our sever, I have decided to use a separate repository. In order to run our
terraform scripts, we need to be able to store the <code class="language-plaintext highlighter-rouge">terraform states</code> to s3. So we need to create a <code class="language-plaintext highlighter-rouge">bucket</code> in <code class="language-plaintext highlighter-rouge">S3</code>.</p>

<h3 id="app-base-infra-for-core-setup"><code class="language-plaintext highlighter-rouge">app-base-infra</code> for core setup</h3>

<blockquote>
  <p>A word about the setup. Presently in terraform, a <code class="language-plaintext highlighter-rouge">hcl</code> file is used to generate the backend config.</p>

</blockquote>

<p>We follow the same way to setup the <code class="language-plaintext highlighter-rouge">CI</code> variables.</p>

<p><code class="language-plaintext highlighter-rouge">.gitlab-ci.yaml</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">validate</span>
  <span class="pi">-</span> <span class="s">deploy</span>
  <span class="pi">-</span> <span class="s">destroy</span>

<span class="na">.template</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">hashicorp/terraform:1.7.1</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">before_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">apk add --no-cache bash py-pip</span>
    <span class="pi">-</span> <span class="s">python3 -m venv .venv</span>
    <span class="pi">-</span> <span class="s">source .venv/bin/activate</span>
    <span class="pi">-</span> <span class="s">pip install --upgrade pip awscli</span>
    <span class="pi">-</span> <span class="s">aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID</span>
    <span class="pi">-</span> <span class="s">aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_AWS_ACCOUNT=${AWS_ACCOUNT}</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_AWS_REGION=${AWS_DEFAULT_REGION}</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_AWS_PROFILE=${AWS_DEFAULT_PROFILE}</span>
    <span class="pi">-</span> <span class="s">export AWS_PROFILE=${AWS_DEFAULT_PROFILE}</span>


<span class="na">validate infra</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> <span class="s">.template</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">validate</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_APP_NAME=talon-server</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_PARAM_PREFIX=talon/apiserver</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_ENVIRONMENT=prod</span>
    <span class="pi">-</span> <span class="s">terraform init -backend-config=./infra.hcl</span>
    <span class="pi">-</span> <span class="s">terraform validate</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>


<span class="na">create infra</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> <span class="s">.template</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">apply</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_APP_NAME=talon-server</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_PARAM_PREFIX=talon/apiserver</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_ENVIRONMENT=prod</span>
    <span class="pi">-</span> <span class="s">export AWS_PROFILE=${AWS_DEFAULT_PROFILE}</span>
    <span class="pi">-</span> <span class="s">terraform plan -out=infra.plan</span>
    <span class="pi">-</span> <span class="s">terraform apply -auto-approve infra.tfplan</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>


<span class="na">destroy infra</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> <span class="s">.template</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">destroy</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_APP_NAME=talon-server</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_PARAM_PREFIX=talon/apiserver</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_ENVIRONMENT=prod</span>
    <span class="pi">-</span> <span class="s">terraform init -backend-config=./infra.hcl</span>
    <span class="pi">-</span> <span class="s">terraform destroy -auto-approve</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>
</code></pre></div></div>

<p>Here, I have made a few considerations.</p>

<p><code class="language-plaintext highlighter-rouge">First</code>, generally in most blogs, the <code class="language-plaintext highlighter-rouge">validate &amp; plan</code> are in one stage, storing the <code class="language-plaintext highlighter-rouge">terraform plan</code> file in artifcat or cache in gitlab.
This causes a security concern, because the <code class="language-plaintext highlighter-rouge">plan</code> file is not like an <code class="language-plaintext highlighter-rouge">ansible vault</code>, its not encrypted. So, I have separated the stages.
Its, <code class="language-plaintext highlighter-rouge">validate</code>, followed by <code class="language-plaintext highlighter-rouge">plan &amp; apply</code>.</p>

<p><code class="language-plaintext highlighter-rouge">Second</code>, for multiple stages, the <code class="language-plaintext highlighter-rouge">TF_VAR_ENVIRONMENT</code> needs to changes, and we can add another bunch of stages. For multiple applications.
There would be more such entries.</p>

<p><code class="language-plaintext highlighter-rouge">Third</code>, Presently, the <code class="language-plaintext highlighter-rouge">infra.hcl</code> file has static values, but there is a workaround to make this dynamic using
environment variables, or <code class="language-plaintext highlighter-rouge">TF_VAR</code> variables or using a bash script to dynamically populate the hcl file.</p>

<p>This kind of begs the question of what happens, when the number of microservices increases.</p>
<blockquote>
  <p>I will come back to this later.</p>
</blockquote>

<h3 id="app-metals-infra-for-ecs-ags-lambda-rds-etc"><code class="language-plaintext highlighter-rouge">app-metals-infra</code> for ecs, ags, lambda, rds etc.</h3>

<p>The setup is exactly same as above. Except here, we follow a directory for each kind of deployment. Presently, the <code class="language-plaintext highlighter-rouge">services</code> directory will
host the IaaC code for running all <code class="language-plaintext highlighter-rouge">EC2</code> or <code class="language-plaintext highlighter-rouge">FARGET</code> backed instances/deployments.</p>

<p>This is like a <code class="language-plaintext highlighter-rouge">Monorepo</code> with sub-directories.</p>

<p><code class="language-plaintext highlighter-rouge">.gitlab-ci.yaml</code> looks like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">validate</span>
  <span class="pi">-</span> <span class="s">deploy</span>
  <span class="pi">-</span> <span class="s">destroy</span>

<span class="na">.template</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">hashicorp/terraform:1.7.1</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">before_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">apk add --no-cache bash py-pip</span>
    <span class="pi">-</span> <span class="s">python3 -m venv .venv</span>
    <span class="pi">-</span> <span class="s">source .venv/bin/activate</span>
    <span class="pi">-</span> <span class="s">pip install --upgrade pip awscli</span>
    <span class="pi">-</span> <span class="s">aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID</span>
    <span class="pi">-</span> <span class="s">aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_AWS_ACCOUNT=${AWS_ACCOUNT}</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_AWS_REGION=${AWS_DEFAULT_REGION}</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_AWS_PROFILE=${AWS_DEFAULT_PROFILE}</span>


<span class="na">validate</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> <span class="s">.template</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">validate</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_APP_NAME=talon-server</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_PARAM_PREFIX=talon/apiserver</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_ENVIRONMENT=prod</span>
    <span class="pi">-</span> <span class="s">cd services</span>
    <span class="pi">-</span> <span class="s">terraform init -backend-config=./talon.hcl</span>
    <span class="pi">-</span> <span class="s">terraform validate</span>

<span class="na">deploy talon server</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> <span class="s">.template</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_APP_NAME=talon-server</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_PARAM_PREFIX=talon/apiserver</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_ENVIRONMENT=prod</span>
    <span class="pi">-</span> <span class="s">cd services</span>
    <span class="pi">-</span> <span class="s">terraform init -backend-config=./talon.hcl</span>
    <span class="pi">-</span> <span class="s">terraform plan -out=talon.tfplan</span>
    <span class="pi">-</span> <span class="s">terraform apply -auto-approve talon.tfplan</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>

<span class="na">destroy talon sever</span><span class="pi">:</span>
  <span class="na">extends</span><span class="pi">:</span> <span class="s">.template</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">destroy</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">TF_ROOT</span><span class="pi">:</span> <span class="s">services</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_APP_NAME=talon-server</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_PARAM_PREFIX=talon/apiserver</span>
    <span class="pi">-</span> <span class="s">export TF_VAR_ENVIRONMENT=prod</span>
    <span class="pi">-</span> <span class="s">cd services</span>
    <span class="pi">-</span> <span class="s">terraform init -backend-config=./talon.hcl</span>
    <span class="pi">-</span> <span class="s">terraform destroy -auto-approve</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>


</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">hcl</code> config files looks like this:</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">bucket</span> <span class="err">=</span> <span class="s2">"app-tfstates"</span>
<span class="nx">key</span>    <span class="err">=</span> <span class="s2">"prod/app/infra/terraform.tfstate"</span>
<span class="nx">region</span> <span class="err">=</span> <span class="s2">"ap-south-1"</span>
</code></pre></div></div>

<h2 id="user-role-creation-with-chatgpt">User Role Creation with ChatGPT:</h2>

<p>In order to execute all these commands, we need proper <code class="language-plaintext highlighter-rouge">Roles</code> setup. Now we could do this, by I don’t know, “reading”.</p>

<p>But why do that, when we can just <strong>crash and burn baby</strong>. I’ve streamlined user creation with ChatGPT:</p>

<ul>
  <li>Create a user with basic permissions.</li>
  <li>Run the pipeline and capture access-related error messages.</li>
  <li>Feed those messages to ChatGPT, which automatically generates the required inline JSON policy.</li>
</ul>

<p>The list is quite big, you can figure that out on your own.</p>

<h2 id="bonus">Bonus</h2>

<p>Here is a bonus script, for your local development, a wrapper around <code class="language-plaintext highlighter-rouge">terraform</code> cli, so that you don’t need to export <code class="language-plaintext highlighter-rouge">TF_VAR</code>s.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># This is a wrapper around terraform to run commands with</span>
<span class="c"># project specific config</span>
<span class="c">#</span>
<span class="c"># USAGE: to use this, first call</span>
<span class="c"># source ./scripts/terrawrapper.sh load-env &lt;env-file&gt;</span>
<span class="c"># ./scripts/terrwrapper &lt;terraform commands&gt;</span>
<span class="c">#</span>
<span class="nb">export </span><span class="nv">AWS_PROFILE</span><span class="o">=</span><span class="s2">"app"</span>

<span class="k">function </span>set_envfile<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"env file name not provided"</span>
  <span class="k">fi

  </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
  <span class="nb">export </span><span class="nv">_TF_ENVFILE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="o">}</span>

<span class="k">function </span>aws_account_id<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">AWS_ACCOUNT_ID</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">AWS_ACCOUNT_ID</span><span class="k">}</span><span class="s2"> aws account id already set"</span>
  <span class="k">else
    </span><span class="nv">value</span><span class="o">=</span><span class="si">$(</span>aws sts <span class="se">\</span>
      get-caller-identity <span class="se">\</span>
      <span class="nt">--query</span> <span class="s2">"Account"</span> <span class="se">\</span>
      <span class="nt">--output</span> text <span class="se">\</span>
      <span class="nt">--profile</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">AWS_PROFILE</span><span class="k">}</span><span class="s2">"</span><span class="se">\</span>
    <span class="si">)</span>
        <span class="nb">export </span><span class="nv">AWS_ACCOUNT_ID</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">value</span><span class="k">}</span><span class="s2">"</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function </span>load_env<span class="o">()</span> <span class="o">{</span>
  <span class="nv">file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">_TF_ENVFILE</span><span class="k">}</span><span class="s2">"</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$file</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"_TF_ENVFILE variable needs to be set"</span>
    <span class="nb">exit </span>1
  <span class="k">fi</span>

  <span class="c"># echo "laoding from $file"</span>

  <span class="nb">declare</span> <span class="nt">-a</span> env_vars

  <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> line<span class="p">;</span> <span class="k">do
    </span><span class="nv">exported_var</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> | envsubst<span class="si">)</span>
    <span class="c"># echo "Exported Variable: $exported_var"</span>
    env_vars+<span class="o">=(</span><span class="s2">"</span><span class="nv">$exported_var</span><span class="s2">"</span><span class="o">)</span>
  <span class="k">done</span> &lt; &lt;<span class="o">(</span><span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'^#'</span> <span class="s2">"</span><span class="nv">$file</span><span class="s2">"</span><span class="o">)</span>

  <span class="nb">export</span> <span class="s2">"</span><span class="k">${</span><span class="nv">env_vars</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span>
  
  <span class="c"># echo "profile $TF_VAR_AWS_PROFILE"</span>
  <span class="c"># echo "app name $TF_VAR_APP_NAME" </span>
  <span class="c"># echo "env values exported"</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"load-env"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"setting env file"</span>
  set_envfile <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="s2">"ENVFILE set to </span><span class="k">${</span><span class="nv">_TF_ENVFILE</span><span class="k">}</span><span class="s2">"</span>
<span class="k">elif</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"get-env"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ENVFILE set to </span><span class="k">${</span><span class="nv">_TF_ENVFILE</span><span class="k">}</span><span class="s2">"</span>
<span class="k">else
  </span>aws_account_id
  load_env

  <span class="k">if</span> <span class="o">[[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$TF_VAR_AWS_ACCOUNT</span><span class="s2">"</span> <span class="o">||</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$TF_VAR_APP_NAME</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="s2">"env values not exported"</span>
      <span class="nb">exit </span>1
  <span class="k">fi

  </span>terraform <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
<span class="k">fi</span>
</code></pre></div></div>

<h2 id="backword">Backword</h2>

<p>IaC has proven to be a valuable tool for streamlining our deployment processes and improving infrastructure management. I’m excited to continue refining our approach and sharing our experiences with the community.</p>

<p><code class="language-plaintext highlighter-rouge">Thank you.</code></p>


      <hr>
      <div class="row mb-5 mt-5">
  <div class="col-md-6 d-flex align-items-end ">
    <span>Thanks. <i>mind sharing?</i></span>
  </div>

  <!-- Right Column with Social Media Icons (on the right for larger screens, on bottom for smaller screens) -->
  <div class="col-md-6 order-md-2 order-1 text-md-right text-center mt-3 mt-md-0">
    <div>

      <a
          href="https://www.linkedin.com/sharing/share-offsite?url=ikouchiha47.github.io/2024/01/11/ci-cd-with-gitlab-aws.html"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          class="d-inline-block mr-2"
       >
        <span class="fa-stack fa-lg" style="color: #0077b5;">
          <i class="fas fa-square fa-stack-2x"></i>
          <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
        </span>
      </a>

      <a
          href="https://twitter.com/intent/tweet?text=Automate deployment with CI/CD&url=ikouchiha47.github.io/2024/01/11/ci-cd-with-gitlab-aws.html"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          class="d-inline-block mr-2">
        <span class="fa-stack fa-lg" style="color: #1DA1F2;">
          <i class="fas fa-square fa-stack-2x"></i>
          <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
      </a>

      <a
          href="http://www.reddit.com/submit?url=ikouchiha47.github.io/2024/01/11/ci-cd-with-gitlab-aws.html"
          onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
          class="d-inline-block mr-2">
        <span class="fa-stack fa-lg" style="color: #FF4500;">
          <i class="fas fa-square fa-stack-2x"></i>
          <i class="fab fa-reddit fa-stack-1x fa-inverse"></i>
        </span>
      </a>
    </div>
  </div>
</div>

<hr/>


      <div class="clearfix">

        
        <a class="btn btn-primary float-left" href="/2024/01/11/building-news-aggregator.html" data-toggle="tooltip" data-placement="top" title="News aggregator">&larr; Previous<span class="d-none d-md-inline">
            Post</span></a>
        
        
        <a class="btn btn-primary float-right" href="/2024/02/03/building-ecommerce-end-to-end.html" data-toggle="tooltip" data-placement="top" title="Building an ecommerce website end to end">Next<span class="d-none d-md-inline">
            Post</span> &rarr;</a>
        

      </div>

    </div>
  </div>
</div>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:amitava.dev@proton.me" class="text-gray">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          <li class="list-inline-item">
            <a href="https://www.linkedin.com/in/amitavaag" class="text-gray">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://github.com/ikouchiha47" class="text-gray">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
        </ul>

        <p class="copyright text-muted">
          Build with: 
          <a 
            href="https://github.com/StartBootstrap/startbootstrap-clean-blog-jekyll"
            class="text-gray"
            target="_blank">startbootstrap-clean-blog-jekyll</a></p>
      </div>
    </div>
  </div>
</footer>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/blog/js/scripts.js"></script>

<script src="/assets/scripts.js"></script>




  

</body>

</html>
